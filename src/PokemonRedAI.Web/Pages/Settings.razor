@page "/settings"
@using PokemonRedAI.Emulator
@using Serilog
@implements IDisposable

<PageTitle>Pokemon Red AI - Settings</PageTitle>

<div class="container-fluid">
    <h3>Settings</h3>

    <div class="row">
        <div class="col-md-6">
            <!-- Emulator Settings -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0">Emulator</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Emulator Type</label>
                        <select class="form-select" @bind="emulatorType">
                            <option value="BizHawk">BizHawk</option>
                            <option value="mGBA">mGBA</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Window Title (for detection)</label>
                        <input type="text" class="form-control" @bind="windowTitle" placeholder="e.g., Pokemon Red" />
                    </div>
                    <div class="d-flex gap-2 flex-wrap">
                        <button class="btn btn-primary" @onclick="DetectEmulator">
                            Detect Emulator
                        </button>
                        <button class="btn btn-outline-secondary" @onclick="ScanAllWindows">
                            Scan All Windows
                        </button>
                        <button class="btn btn-outline-info" @onclick="RunDiagnostics">
                            Run Diagnostics
                        </button>
                    </div>
                    <div class="mt-2">
                        <span class="@(emulatorConnected ? "text-success" : "text-danger")">
                            @(emulatorConnected ? $"Connected: {connectedWindowTitle}" : "Not Connected")
                        </span>
                    </div>
                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-warning mt-2" role="alert">
                            @errorMessage
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(diagnosticOutput))
                    {
                        <div class="mt-3">
                            <pre class="bg-dark text-light p-3" style="max-height: 400px; overflow-y: auto; font-size: 12px;">@diagnosticOutput</pre>
                        </div>
                    }
                </div>
            </div>

            <!-- Detected Windows -->
            @if (detectedWindows.Count > 0)
            {
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="mb-0">Detected Windows (@detectedWindows.Count)</h5>
                    </div>
                    <div class="card-body p-0">
                        <div style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm table-striped mb-0">
                                <thead>
                                    <tr>
                                        <th>Process</th>
                                        <th>Window Title</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var window in detectedWindows)
                                    {
                                        <tr>
                                            <td><code>@window.ProcessName</code></td>
                                            <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                                @window.Title
                                            </td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary" @onclick="() => SelectWindow(window)">
                                                    Select
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            }

            <!-- Input Timing -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0">Input Timing</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Key Press Duration (ms)</label>
                        <input type="number" class="form-control" @bind="keyPressDuration" min="20" max="200" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Delay Between Inputs (ms)</label>
                        <input type="number" class="form-control" @bind="inputDelay" min="50" max="500" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Movement Wait Time (ms)</label>
                        <input type="number" class="form-control" @bind="movementWait" min="100" max="1000" />
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <!-- Key Mappings -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0">Key Mappings</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Action</th>
                                <th>Key</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>A Button (Confirm)</td>
                                <td><input type="text" class="form-control form-control-sm" @bind="keyA" style="width: 80px;" /></td>
                            </tr>
                            <tr>
                                <td>B Button (Cancel)</td>
                                <td><input type="text" class="form-control form-control-sm" @bind="keyB" style="width: 80px;" /></td>
                            </tr>
                            <tr>
                                <td>Up</td>
                                <td><input type="text" class="form-control form-control-sm" @bind="keyUp" style="width: 80px;" /></td>
                            </tr>
                            <tr>
                                <td>Down</td>
                                <td><input type="text" class="form-control form-control-sm" @bind="keyDown" style="width: 80px;" /></td>
                            </tr>
                            <tr>
                                <td>Left</td>
                                <td><input type="text" class="form-control form-control-sm" @bind="keyLeft" style="width: 80px;" /></td>
                            </tr>
                            <tr>
                                <td>Right</td>
                                <td><input type="text" class="form-control form-control-sm" @bind="keyRight" style="width: 80px;" /></td>
                            </tr>
                            <tr>
                                <td>Start</td>
                                <td><input type="text" class="form-control form-control-sm" @bind="keyStart" style="width: 80px;" /></td>
                            </tr>
                            <tr>
                                <td>Select</td>
                                <td><input type="text" class="form-control form-control-sm" @bind="keySelect" style="width: 80px;" /></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Auto-Save -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0">Auto-Save</h5>
                </div>
                <div class="card-body">
                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" id="autoSaveEnabled" @bind="autoSaveEnabled" />
                        <label class="form-check-label" for="autoSaveEnabled">Enable Auto-Save</label>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Auto-Save Interval (seconds)</label>
                        <input type="number" class="form-control" @bind="autoSaveInterval" min="10" max="300" disabled="@(!autoSaveEnabled)" />
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-3">
        <div class="col-12">
            <button class="btn btn-primary" @onclick="SaveSettings">
                Save Settings
            </button>
            <button class="btn btn-secondary ms-2" @onclick="ResetDefaults">
                Reset to Defaults
            </button>
        </div>
    </div>
</div>

@code {
    private string emulatorType = "mGBA";
    private string windowTitle = "";
    private bool emulatorConnected = false;
    private string connectedWindowTitle = "";
    private List<EmulatorWindow> detectedWindows = new();
    private string diagnosticOutput = "";
    private string errorMessage = "";

    private int keyPressDuration = 50;
    private int inputDelay = 100;
    private int movementWait = 250;

    private string keyA = "X";
    private string keyB = "Z";
    private string keyUp = "Up";
    private string keyDown = "Down";
    private string keyLeft = "Left";
    private string keyRight = "Right";
    private string keyStart = "Enter";
    private string keySelect = "Backspace";

    private bool autoSaveEnabled = true;
    private int autoSaveInterval = 60;

    private EmulatorConnector? _connector;
    private bool _initialized = false;

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender && !_initialized)
        {
            _initialized = true;
            try
            {
                _connector = new EmulatorConnector();
            }
            catch (Exception ex)
            {
                errorMessage = $"Failed to initialize EmulatorConnector: {ex.Message}";
                StateHasChanged();
            }
        }
    }

    private async Task DetectEmulator()
    {
        try
        {
            Log.Information("DetectEmulator button clicked - STARTING");
            errorMessage = "Button clicked! Searching...";
            StateHasChanged();

            // Small delay to let UI update
            await Task.Delay(100);

            Log.Information("Step 1: Checking connector");
            if (_connector == null)
            {
                Log.Information("Step 2: Creating new EmulatorConnector");
                _connector = new EmulatorConnector();
            }

            Log.Information("Step 3: Calling FindEmulatorWindows...");
            var result = _connector.FindEmulatorWindows();
            Log.Information("Step 4: Got result, converting to list...");
            detectedWindows = result.ToList();
            Log.Information("Step 5: FindEmulatorWindows returned {Count} windows", detectedWindows.Count);

            if (detectedWindows.Count > 0)
            {
                // Auto-select the first one
                var firstWindow = detectedWindows.First();
                Log.Information("Step 6: Connecting to first window: {Title}", firstWindow.Title);
                if (_connector.Connect(firstWindow.Handle))
                {
                    emulatorConnected = true;
                    connectedWindowTitle = firstWindow.Title;
                    errorMessage = "";
                    Log.Information("Step 7: Successfully connected to emulator");
                }
            }
            else
            {
                emulatorConnected = false;
                connectedWindowTitle = "";
                errorMessage = "No emulator windows found. Click 'Scan All Windows' to see all available windows.";
                Log.Warning("No emulator windows found");
            }
        }
        catch (Exception ex)
        {
            Log.Error(ex, "Error in DetectEmulator");
            errorMessage = $"Error detecting emulator: {ex.Message}\n{ex.StackTrace}";
        }
    }

    private async Task ScanAllWindows()
    {
        try
        {
            Log.Information("ScanAllWindows button clicked");
            errorMessage = "Scanning all windows...";
            StateHasChanged();
            await Task.Delay(100);

            if (_connector == null)
            {
                Log.Information("Creating new EmulatorConnector");
                _connector = new EmulatorConnector();
            }

            Log.Information("Calling FindAllWindows...");
            detectedWindows = _connector.FindAllWindows()
                .OrderBy(w => w.ProcessName)
                .ThenBy(w => w.Title)
                .ToList();
            Log.Information("FindAllWindows returned {Count} windows", detectedWindows.Count);

            if (detectedWindows.Count == 0)
            {
                errorMessage = "No windows found. This might be a permissions issue.";
                Log.Warning("No windows found");
            }
            else
            {
                errorMessage = "";
            }
        }
        catch (Exception ex)
        {
            Log.Error(ex, "Error in ScanAllWindows");
            errorMessage = $"Error scanning windows: {ex.Message}";
        }
    }

    private async Task RunDiagnostics()
    {
        try
        {
            Log.Information("RunDiagnostics button clicked");
            errorMessage = "Running diagnostics...";
            StateHasChanged();
            await Task.Delay(100);

            if (_connector == null)
            {
                Log.Information("Creating new EmulatorConnector");
                _connector = new EmulatorConnector();
            }

            Log.Information("Calling GetDiagnosticInfo...");
            diagnosticOutput = _connector.GetDiagnosticInfo();
            errorMessage = "";
            Log.Information("GetDiagnosticInfo completed, output length: {Length}", diagnosticOutput?.Length ?? 0);
        }
        catch (Exception ex)
        {
            Log.Error(ex, "Error in RunDiagnostics");
            errorMessage = $"Error running diagnostics: {ex.Message}";
            diagnosticOutput = $"Exception: {ex}";
        }
    }

    private void SelectWindow(EmulatorWindow window)
    {
        errorMessage = "";
        try
        {
            if (_connector == null)
            {
                _connector = new EmulatorConnector();
            }

            if (_connector.Connect(window.Handle))
            {
                emulatorConnected = true;
                connectedWindowTitle = window.Title;
            }
            else
            {
                errorMessage = "Failed to connect to selected window.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error selecting window: {ex.Message}";
        }
    }

    private void SaveSettings()
    {
        // Save settings to configuration
    }

    private void ResetDefaults()
    {
        emulatorType = "mGBA";
        windowTitle = "";
        keyPressDuration = 50;
        inputDelay = 100;
        movementWait = 250;
        keyA = "X";
        keyB = "Z";
        keyUp = "Up";
        keyDown = "Down";
        keyLeft = "Left";
        keyRight = "Right";
        keyStart = "Enter";
        keySelect = "Backspace";
        autoSaveEnabled = true;
        autoSaveInterval = 60;
    }

    public void Dispose()
    {
        _connector?.Dispose();
    }
}
